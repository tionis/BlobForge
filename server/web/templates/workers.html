{{template "base" .}}

{{define "content"}}
<div class="page-header">
    <h1 class="page-title">Workers</h1>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="BlobForge.showModal('add-worker-modal')">
            + Register Worker
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body" id="workers-table" 
         hx-get="/partials/workers" 
         hx-trigger="every 5s, sse:worker_online, sse:worker_offline" 
         hx-swap="innerHTML">
        {{template "workers_table.html" .}}
    </div>
</div>

<!-- Worker Setup Guide -->
<div class="card mb-4">
    <div class="card-header">
        <h2>Worker Setup Guide</h2>
        <button class="btn btn-sm" onclick="this.closest('.card').querySelector('.card-body').classList.toggle('hidden')">
            Toggle
        </button>
    </div>
    <div class="card-body hidden">
        <div class="setup-guide">
            <h3>Quick Start</h3>
            <p class="text-muted mb-4">To run a PDF worker, you need Python 3.10+ and an API token.</p>
            
            <h4>1. Get an API Token</h4>
            <p class="text-muted">Go to <a href="/admin" class="link">Admin â†’ API Tokens</a> and create a new token.</p>
            
            <h4>2. Install Dependencies</h4>
            <pre class="code-block">pip install httpx marker-pdf</pre>
            
            <h4>3. Run the Worker</h4>
            <pre class="code-block"># Set environment variables
export BLOBFORGE_SERVER_URL={{.ServerURL}}
export BLOBFORGE_API_TOKEN=bf_your_token_here

# Optional: Enable GPU (requires CUDA)
export BLOBFORGE_USE_GPU=true

# Run the worker
python worker.py</pre>

            <h4>4. Docker (Alternative)</h4>
            <pre class="code-block">docker run -d \
  -e BLOBFORGE_SERVER_URL={{.ServerURL}} \
  -e BLOBFORGE_API_TOKEN=bf_your_token_here \
  ghcr.io/tionis/blobforge-pdf-worker:latest</pre>
        </div>
    </div>
</div>

<!-- Add Worker Modal -->
<div id="add-worker-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3>Register New Worker</h3>
            <button class="modal-close" onclick="BlobForge.hideModal('add-worker-modal')">&times;</button>
        </div>
        <form hx-post="/actions/workers/register" hx-target="#add-worker-result" hx-swap="innerHTML">
            <div class="modal-body">
                <p class="text-muted mb-4">
                    Workers typically self-register when they start. Use this form to pre-register a worker 
                    or for testing purposes.
                </p>
                <div class="form-group">
                    <label class="form-label">Worker Name</label>
                    <input type="text" name="name" required class="form-input" placeholder="worker-01">
                </div>
                <div class="form-group">
                    <label class="form-label">Worker Type</label>
                    <select name="worker_type" class="form-select">
                        <option value="pdf-convert">PDF Convert</option>
                        <option value="ocr">OCR</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div id="add-worker-result"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="BlobForge.hideModal('add-worker-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Register</button>
            </div>
        </form>
    </div>
</div>
{{end}}
