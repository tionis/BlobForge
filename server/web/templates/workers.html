{{template "base" .}}

{{define "content"}}
<div class="page-header">
    <h1 class="page-title">Workers</h1>
    <div class="page-actions">
        {{if .IsAdmin}}
        <button class="btn btn-primary" onclick="BlobForge.showModal('create-worker-modal')">
            + Create Worker
        </button>
        {{end}}
    </div>
</div>

<div class="card">
    <div class="card-body" id="workers-table" 
         hx-get="/partials/workers" 
         hx-trigger="every 5s, sse:worker_online, sse:worker_offline, workersUpdated from:body" 
         hx-swap="innerHTML">
        {{template "workers_table.html" .}}
    </div>
</div>

<!-- Worker Setup Guide -->
<div class="card mb-4">
    <div class="card-header">
        <h2>Worker Setup Guide</h2>
        <button class="btn btn-sm" onclick="this.closest('.card').querySelector('.card-body').classList.toggle('hidden')">
            Toggle
        </button>
    </div>
    <div class="card-body hidden">
        <div class="setup-guide">
            <h3>Quick Start</h3>
            <p class="text-muted mb-4">To run a PDF worker, you need Python 3.10+ and worker credentials.</p>
            
            <h4>1. Create a Worker (Admin)</h4>
            <p class="text-muted">Click "Create Worker" above to generate credentials. The secret is shown only once!</p>
            
            <h4>2. Install Dependencies</h4>
            <pre class="code-block">pip install httpx marker-pdf</pre>
            
            <h4>3. Run the Worker</h4>
            <pre class="code-block"># Set environment variables
export BLOBFORGE_SERVER_URL={{.ServerURL}}
export BLOBFORGE_WORKER_ID=your-worker-id
export BLOBFORGE_WORKER_SECRET=bfw_your_secret_here

# Optional: Enable GPU (requires CUDA)
export BLOBFORGE_USE_GPU=true

# Run the worker
python worker.py</pre>

            <h4>4. Docker (Alternative)</h4>
            <pre class="code-block">docker run -d \
  -e BLOBFORGE_SERVER_URL={{.ServerURL}} \
  -e BLOBFORGE_WORKER_ID=your-worker-id \
  -e BLOBFORGE_WORKER_SECRET=bfw_your_secret_here \
  ghcr.io/tionis/blobforge-pdf-worker:latest</pre>
        </div>
    </div>
</div>

{{if .IsAdmin}}
<!-- Create Worker Modal -->
<div id="create-worker-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3>Create New Worker</h3>
            <button class="modal-close" onclick="BlobForge.hideModal('create-worker-modal')">&times;</button>
        </div>
        <form id="create-worker-form" onsubmit="return BlobForge.createWorker(event)">
            <div class="modal-body">
                <p class="text-muted mb-4">
                    Create a worker and get its secret. <strong>The secret is shown only once!</strong>
                </p>
                <div class="form-group">
                    <label class="form-label">Worker ID</label>
                    <input type="text" name="id" required class="form-input" placeholder="pdf-worker-01" pattern="[a-zA-Z0-9_-]+">
                    <small class="text-muted">Letters, numbers, dashes, and underscores only</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Worker Name (optional)</label>
                    <input type="text" name="name" class="form-input" placeholder="PDF Worker 1">
                </div>
                <div class="form-group">
                    <label class="form-label">Worker Type</label>
                    <select name="type" class="form-select">
                        <option value="pdf-convert">PDF Convert</option>
                        <option value="ocr">OCR</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div id="create-worker-result"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="BlobForge.hideModal('create-worker-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Worker</button>
            </div>
        </form>
    </div>
</div>

<!-- Worker Secret Display Modal -->
<div id="worker-secret-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3>Worker Created Successfully</h3>
            <button class="modal-close" onclick="BlobForge.hideModal('worker-secret-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning mb-4">
                <strong>‚ö†Ô∏è Important:</strong> Copy this secret now! It will not be shown again.
            </div>
            <div class="form-group">
                <label class="form-label">Worker ID</label>
                <input type="text" id="new-worker-id" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Worker Secret</label>
                <div class="flex gap-2">
                    <input type="text" id="new-worker-secret" class="form-input font-mono flex-1" readonly>
                    <button type="button" class="btn btn-secondary" onclick="BlobForge.copySecret()">
                        üìã Copy
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Environment Variables</label>
                <pre class="code-block" id="worker-env-vars"></pre>
                <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="BlobForge.copyEnvVars()">
                    üìã Copy Environment Variables
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="BlobForge.hideModal('worker-secret-modal'); htmx.trigger(document.body, 'workersUpdated');">Done</button>
        </div>
    </div>
</div>

<!-- Regenerate Secret Modal -->
<div id="regenerate-secret-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3>Regenerate Worker Secret</h3>
            <button class="modal-close" onclick="BlobForge.hideModal('regenerate-secret-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning mb-4">
                <strong>‚ö†Ô∏è Warning:</strong> This will invalidate the current secret. The worker will need to be reconfigured.
            </div>
            <p>Worker ID: <strong id="regenerate-worker-id"></strong></p>
            <div id="regenerate-result"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="BlobForge.hideModal('regenerate-secret-modal')">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="BlobForge.confirmRegenerateSecret()">Regenerate Secret</button>
        </div>
    </div>
</div>
{{end}}
{{end}}
